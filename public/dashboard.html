<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Values Manager - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066ff;
            --primary-dark: #0052cc;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --background: #0a0e27;
            --surface: #1a1f3a;
            --surface-light: #242b4d;
            --text: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--background) 0%, #1e293b 100%);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background: var(--surface);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.875rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: var(--surface-light);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 102, 255, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--surface-light);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .sidebar {
            background: var(--surface);
            border-radius: 12px;
            padding: 1.5rem;
            height: fit-content;
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .sidebar h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .location-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .location-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--surface-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .location-item:hover {
            background: var(--background);
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .location-item.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-color: var(--primary);
        }

        .location-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .location-id {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .content-area {
            background: var(--surface);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            position: relative;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
        }

        .items-grid {
            display: grid;
            gap: 1rem;
        }

        .item-card {
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .item-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .item-card:hover {
            background: var(--background);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .item-card:hover::before {
            transform: scaleY(1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .item-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .item-value {
            background: var(--background);
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            font-family: monospace;
            word-break: break-all;
            border: 1px solid var(--border);
        }

        .item-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--text);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--surface);
            border-radius: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideInRight 0.3s ease;
            z-index: 2000;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--danger);
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .bulk-actions {
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .bulk-actions h3 {
            margin-bottom: 1rem;
            color: var(--text);
        }

        .checkbox-group {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            background: var(--background);
            border-radius: 4px;
        }

        .checkbox-item:hover {
            background: var(--surface);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 0.75rem;
        }

        .field-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--primary);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .error-state {
            background: var(--surface);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            margin: 2rem auto;
            max-width: 600px;
            border: 1px solid var(--danger);
        }

        .error-state h2 {
            color: var(--danger);
            margin-bottom: 1rem;
        }

        .error-state p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .error-state .btn {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>Custom Values Manager</h1>
            <div class="auth-status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </div>
    </header>

    <div class="container" id="appContainer">
        <!-- Main content - no auth section needed -->
        <div class="main-content" id="mainContent">
            <aside class="sidebar">
                <h2>Subaccounts</h2>
                <div class="location-list" id="locationList">
                    <div class="empty-state">
                        <div class="loading"></div>
                        <p>Loading locations...</p>
                    </div>
                </div>
            </aside>

            <main class="content-area">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('values')">Custom Values</button>
                    <button class="tab" onclick="switchTab('fields')">Custom Fields</button>
                    <button class="tab" onclick="switchTab('bulk')">Bulk Operations</button>
                </div>

                <div class="tab-content active" id="valuesTab">
                    <div class="actions-bar">
                        <div class="search-box">
                            <input type="text" placeholder="Search custom values..." id="valuesSearch" onkeyup="filterItems('values')">
                        </div>
                        <button class="btn btn-success" onclick="openModal('value')">
                            <span>‚ûï</span> Add Custom Value
                        </button>
                    </div>
                    <div class="items-grid" id="valuesList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>Select a location to view custom values</p>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="fieldsTab">
                    <div class="actions-bar">
                        <div class="search-box">
                            <input type="text" placeholder="Search custom fields..." id="fieldsSearch" onkeyup="filterItems('fields')">
                        </div>
                        <button class="btn btn-success" onclick="openModal('field')">
                            <span>‚ûï</span> Add Custom Field
                        </button>
                    </div>
                    <div class="items-grid" id="fieldsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>Select a location to view custom fields</p>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="bulkTab">
                    <div class="bulk-actions">
                        <h3>Copy Custom Values & Fields</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                            Select a source location above, then choose target locations to copy custom values and fields.
                        </p>
                        
                        <div class="form-group">
                            <label class="form-label">Target Locations</label>
                            <div class="checkbox-group" id="targetLocations"></div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn" onclick="bulkCopy('values')">
                                <span>üìã</span> Copy Custom Values
                            </button>
                            <button class="btn" onclick="bulkCopy('fields')">
                                <span>üìã</span> Copy Custom Fields
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal for creating/editing items -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add Custom Value</h2>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <form id="itemForm" onsubmit="saveItem(event)">
                <div id="modalFields"></div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentCompanyId = null;
        let currentLocationId = null;
        let locations = [];
        let currentItemType = 'value';
        let editingItemId = null;

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentCompanyId = urlParams.get('companyId');
            
            if (!currentCompanyId) {
                // No companyId - show error
                showAuthError();
            } else {
                // Company ID exists - load data
                document.getElementById('statusIndicator').classList.add('connected');
                document.getElementById('statusText').textContent = 'Connected';
                loadLocations();
            }
        });

        function showAuthError() {
            document.getElementById('appContainer').innerHTML = `
                <div class="error-state">
                    <h2>Authentication Required</h2>
                    <p>You need to install this app through the marketplace to access the dashboard.</p>
                    <a href="/install" class="btn">Install App</a>
                </div>
            `;
        }

        async function loadLocations() {
            try {
                const response = await fetch(`/api/locations?companyId=${currentCompanyId}`);
                if (!response.ok) {
                    if (response.status === 401) {
                        // Token expired or invalid
                        showAuthError();
                        return;
                    }
                    throw new Error('Failed to load locations');
                }
                
                const data = await response.json();
                locations = data.locations || [];
                renderLocations();
            } catch (error) {
                console.error('Error loading locations:', error);
                showToast('Failed to load locations. Please try reinstalling the app.', 'error');
            }
        }

        function renderLocations() {
            const locationList = document.getElementById('locationList');
            if (locations.length === 0) {
                locationList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìç</div>
                        <p>No locations found</p>
                    </div>
                `;
                return;
            }

            locationList.innerHTML = locations.map(location => `
                <div class="location-item" onclick="selectLocation('${location.id}')" data-location-id="${location.id}">
                    <div class="location-name">${location.name}</div>
                    <div class="location-id">${location.id}</div>
                </div>
            `).join('');

            // Also populate bulk operations checkboxes
            const targetLocations = document.getElementById('targetLocations');
            targetLocations.innerHTML = locations.map(location => `
                <div class="checkbox-item">
                    <input type="checkbox" id="target-${location.id}" value="${location.id}">
                    <label for="target-${location.id}">${location.name}</label>
                </div>
            `).join('');
        }

        async function selectLocation(locationId) {
            currentLocationId = locationId;
            
            // Update UI
            document.querySelectorAll('.location-item').forEach(item => {
                item.classList.toggle('active', item.dataset.locationId === locationId);
            });

            // Load custom values and fields
            await Promise.all([
                loadCustomValues(),
                loadCustomFields()
            ]);
        }

        async function loadCustomValues() {
            const valuesList = document.getElementById('valuesList');
            valuesList.innerHTML = '<div class="loading"></div>';

            try {
                const response = await fetch(`/api/custom-values/${currentLocationId}?companyId=${currentCompanyId}`);
                if (response.ok) {
                    const data = await response.json();
                    renderCustomValues(data.customValues || []);
                } else {
                    valuesList.innerHTML = '<div class="empty-state">Failed to load custom values</div>';
                }
            } catch (error) {
                console.error('Error loading custom values:', error);
                valuesList.innerHTML = '<div class="empty-state">Error loading custom values</div>';
            }
        }

        async function loadCustomFields() {
            const fieldsList = document.getElementById('fieldsList');
            fieldsList.innerHTML = '<div class="loading"></div>';

            try {
                const response = await fetch(`/api/custom-fields/${currentLocationId}?companyId=${currentCompanyId}`);
                if (response.ok) {
                    const data = await response.json();
                    renderCustomFields(data.customFields || []);
                } else {
                    fieldsList.innerHTML = '<div class="empty-state">Failed to load custom fields</div>';
                }
            } catch (error) {
                console.error('Error loading custom fields:', error);
                fieldsList.innerHTML = '<div class="empty-state">Error loading custom fields</div>';
            }
        }

        function renderCustomValues(values) {
            const valuesList = document.getElementById('valuesList');
            
            if (values.length === 0) {
                valuesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No custom values found</p>
                    </div>
                `;
                return;
            }

            valuesList.innerHTML = values.map(value => `
                <div class="item-card" data-name="${value.name.toLowerCase()}">
                    <div class="item-header">
                        <div class="item-name">${value.name}</div>
                        <div class="item-actions">
                            <button class="btn btn-small btn-secondary" onclick="editItem('value', '${value.id}', ${JSON.stringify(value).replace(/"/g, '&quot;')})">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-danger" onclick="deleteItem('value', '${value.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="item-value">${value.value}</div>
                    <div class="item-meta">
                        <span>ID: ${value.id}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderCustomFields(fields) {
            const fieldsList = document.getElementById('fieldsList');
            
            if (fields.length === 0) {
                fieldsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No custom fields found</p>
                    </div>
                `;
                return;
            }

            fieldsList.innerHTML = fields.map(field => `
                <div class="item-card" data-name="${field.name.toLowerCase()}">
                    <div class="item-header">
                        <div class="item-name">${field.name}</div>
                        <div class="item-actions">
                            <button class="btn btn-small btn-secondary" onclick="editItem('field', '${field.id}', ${JSON.stringify(field).replace(/"/g, '&quot;')})">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-danger" onclick="deleteItem('field', '${field.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <span class="field-type-badge">${field.dataType}</span>
                    </div>
                    ${field.picklistOptions ? `
                        <div class="item-value">Options: ${field.picklistOptions.join(', ')}</div>
                    ` : ''}
                    <div class="item-meta">
                        <span>ID: ${field.id}</span>
                        ${field.position !== undefined ? `<span>Position: ${field.position}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tab}Tab`).classList.add('active');
        }

        function filterItems(type) {
            const searchTerm = document.getElementById(`${type}Search`).value.toLowerCase();
            const cards = document.querySelectorAll(`#${type}List .item-card`);
            
            cards.forEach(card => {
                const name = card.dataset.name;
                card.style.display = name.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function openModal(type) {
            if (!currentLocationId) {
                showToast('Please select a location first', 'error');
                return;
            }

            currentItemType = type;
            editingItemId = null;
            
            document.getElementById('modalTitle').textContent = `Add Custom ${type === 'value' ? 'Value' : 'Field'}`;
            
            const modalFields = document.getElementById('modalFields');
            
            if (type === 'value') {
                modalFields.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" id="itemName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Value</label>
                        <textarea class="form-textarea" id="itemValue" required></textarea>
                    </div>
                `;
            } else {
                modalFields.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-input" id="itemName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data Type</label>
                        <select class="form-select" id="dataType" onchange="onDataTypeChange()">
                            <option value="TEXT">Text</option>
                            <option value="TEXTAREA">Text Area</option>
                            <option value="NUMBER">Number</option>
                            <option value="PHONE">Phone</option>
                            <option value="EMAIL">Email</option>
                            <option value="DATE">Date</option>
                            <option value="DATETIME">Date & Time</option>
                            <option value="CHECKBOX">Checkbox</option>
                            <option value="SINGLE_OPTIONS">Single Option</option>
                            <option value="MULTIPLE_OPTIONS">Multiple Options</option>
                            <option value="FILE_UPLOAD">File Upload</option>
                            <option value="SIGNATURE">Signature</option>
                        </select>
                    </div>
                    <div class="form-group" id="optionsGroup" style="display: none;">
                        <label class="form-label">Options (one per line)</label>
                        <textarea class="form-textarea" id="picklistOptions" placeholder="Option 1\nOption 2\nOption 3"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Placeholder</label>
                        <input type="text" class="form-input" id="placeholder">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Position</label>
                        <input type="number" class="form-input" id="position" min="0">
                    </div>
                `;
            }
            
            document.getElementById('itemModal').classList.add('active');
        }

        function editItem(type, id, data) {
            currentItemType = type;
            editingItemId = id;
            
            document.getElementById('modalTitle').textContent = `Edit Custom ${type === 'value' ? 'Value' : 'Field'}`;
            openModal(type);
            
            // Populate form with existing data
            if (type === 'value') {
                document.getElementById('itemName').value = data.name;
                document.getElementById('itemValue').value = data.value;
            } else {
                document.getElementById('itemName').value = data.name;
                document.getElementById('dataType').value = data.dataType;
                if (data.placeholder) document.getElementById('placeholder').value = data.placeholder;
                if (data.position !== undefined) document.getElementById('position').value = data.position;
                
                if (data.picklistOptions && data.picklistOptions.length > 0) {
                    document.getElementById('optionsGroup').style.display = 'block';
                    document.getElementById('picklistOptions').value = data.picklistOptions.join('\n');
                }
            }
        }

        function onDataTypeChange() {
            const dataType = document.getElementById('dataType').value;
            const optionsGroup = document.getElementById('optionsGroup');
            
            if (dataType === 'SINGLE_OPTIONS' || dataType === 'MULTIPLE_OPTIONS') {
                optionsGroup.style.display = 'block';
            } else {
                optionsGroup.style.display = 'none';
            }
        }

        function closeModal() {
            document.getElementById('itemModal').classList.remove('active');
            document.getElementById('itemForm').reset();
        }

        async function saveItem(event) {
            event.preventDefault();
            
            const data = {};
            
            if (currentItemType === 'value') {
                data.name = document.getElementById('itemName').value;
                data.value = document.getElementById('itemValue').value;
            } else {
                data.name = document.getElementById('itemName').value;
                data.dataType = document.getElementById('dataType').value;
                
                const placeholder = document.getElementById('placeholder').value;
                if (placeholder) data.placeholder = placeholder;
                
                const position = document.getElementById('position').value;
                if (position) data.position = parseInt(position);
                
                const dataType = document.getElementById('dataType').value;
                if (dataType === 'SINGLE_OPTIONS' || dataType === 'MULTIPLE_OPTIONS') {
                    const options = document.getElementById('picklistOptions').value
                        .split('\n')
                        .map(opt => opt.trim())
                        .filter(opt => opt);
                    if (options.length > 0) data.picklistOptions = options;
                }
            }
            
            try {
                const endpoint = currentItemType === 'value' ? 'custom-values' : 'custom-fields';
                const method = editingItemId ? 'PUT' : 'POST';
                const url = editingItemId 
                    ? `/api/${endpoint}/${currentLocationId}/${editingItemId}?companyId=${currentCompanyId}`
                    : `/api/${endpoint}/${currentLocationId}?companyId=${currentCompanyId}`;
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showToast(`Custom ${currentItemType} ${editingItemId ? 'updated' : 'created'} successfully`, 'success');
                    closeModal();
                    
                    if (currentItemType === 'value') {
                        loadCustomValues();
                    } else {
                        loadCustomFields();
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save item');
                }
            } catch (error) {
                console.error('Error saving item:', error);
                showToast(error.message || 'Failed to save item', 'error');
            }
        }

        async function deleteItem(type, id) {
            if (!confirm(`Are you sure you want to delete this custom ${type}?`)) {
                return;
            }
            
            try {
                const endpoint = type === 'value' ? 'custom-values' : 'custom-fields';
                const response = await fetch(`/api/${endpoint}/${currentLocationId}/${id}?companyId=${currentCompanyId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showToast(`Custom ${type} deleted successfully`, 'success');
                    
                    if (type === 'value') {
                        loadCustomValues();
                    } else {
                        loadCustomFields();
                    }
                } else {
                    throw new Error('Failed to delete item');
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showToast('Failed to delete item', 'error');
            }
        }

        async function bulkCopy(type) {
            if (!currentLocationId) {
                showToast('Please select a source location first', 'error');
                return;
            }
            
            const targetLocationIds = Array.from(document.querySelectorAll('#targetLocations input:checked'))
                .map(checkbox => checkbox.value)
                .filter(id => id !== currentLocationId);
            
            if (targetLocationIds.length === 0) {
                showToast('Please select at least one target location', 'error');
                return;
            }
            
            if (!confirm(`Copy all custom ${type} from the selected location to ${targetLocationIds.length} location(s)?`)) {
                return;
            }
            
            try {
                const endpoint = type === 'values' ? 'copy-custom-values' : 'copy-custom-fields';
                const response = await fetch(`/api/bulk/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        companyId: currentCompanyId,
                        sourceLocationId: currentLocationId,
                        targetLocationIds
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showToast(`Custom ${type} copied successfully to ${targetLocationIds.length} location(s)`, 'success');
                } else {
                    throw new Error('Failed to copy items');
                }
            } catch (error) {
                console.error('Error copying items:', error);
                showToast('Failed to copy items', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
